{% extends "base.html" %}

{% block title %}Product Management{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 32px;">
    <h1 style="font-size: 48px; font-weight: 700; margin-bottom: 8px;">
        <i class="fas fa-cogs" style="color: var(--brand);"></i> Product Management
    </h1>
    <p class="text-secondary">Manage Opportunity Engine development - Select features to build</p>
</div>

<!-- Stats -->
<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 32px;">
    <div class="card" style="padding: 20px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--brand);">{{ stats.tools_count }}</div>
        <div class="text-muted" style="font-size: 13px;">Tools</div>
    </div>
    <div class="card" style="padding: 20px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--success);">{{ stats.total_features_built }}</div>
        <div class="text-muted" style="font-size: 13px;">Built</div>
    </div>
    <div class="card" style="padding: 20px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--warning);">{{ stats.total_features_missing }}</div>
        <div class="text-muted" style="font-size: 13px;">Missing</div>
    </div>
    <div class="card" style="padding: 20px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--info);">{{ stats.roadmap_pending }}</div>
        <div class="text-muted" style="font-size: 13px;">In Roadmap</div>
    </div>
    <div class="card" style="padding: 20px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: var(--error);">{{ stats.high_impact_features }}</div>
        <div class="text-muted" style="font-size: 13px;">High Impact</div>
    </div>
</div>

<!-- Build Roadmap Section -->
{% if roadmap %}
<div class="card mb-4" style="border-color: var(--success);">
    <div class="card-header">
        <div class="card-title" style="color: var(--success);">
            <i class="fas fa-hammer"></i> Build Roadmap ({{ roadmap|length }} items)
        </div>
    </div>
    <div style="max-height: 300px; overflow-y: auto;">
        {% for item in roadmap %}
        <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 12px; border-left: 4px solid {% if item.status == 'built' %}var(--success){% else %}var(--warning){% endif %};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600;">{{ item.feature }}</div>
                    <div class="text-muted" style="font-size: 13px;">{{ item.tool }} â€¢ {{ item.description[:80] }}...</div>
                    <div style="margin-top: 8px;">
                        <span class="badge badge-blue">{{ item.effort }}</span>
                        <span class="badge {% if item.impact == 'high' %}badge-green{% elif item.impact == 'medium' %}badge-yellow{% else %}badge-gray{% endif %}">{{ item.impact }} impact</span>
                        <span class="badge {% if item.status == 'built' %}badge-green{% else %}badge-yellow{% endif %}">{{ item.status }}</span>
                    </div>
                </div>
                {% if item.status == 'pending' %}
                <button onclick="markBuilt('{{ item.id }}')" class="btn btn-success btn-sm">
                    <i class="fas fa-check"></i> Mark Built
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Feature Catalog -->
<form id="features-form" onsubmit="return addToRoadmap(event)">
    {% for tool_id, tool in features.items() %}
    <div class="card mb-4">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div class="card-title">
                <i class="fas {{ tool.icon }}"></i> {{ tool.name }}
                <span class="text-muted" style="font-size: 14px; margin-left: 12px;">
                    {{ tool.built_features|length }} built, {{ tool.missing_features|length }} missing
                </span>
            </div>
            <button type="button" onclick="generateMore('{{ tool_id }}')" class="btn btn-secondary btn-sm">
                <i class="fas fa-magic"></i> Generate More Ideas
            </button>
        </div>
        
        {% if tool.missing_features %}
        <div style="display: flex; flex-direction: column; gap: 12px;">
            {% for feature in tool.missing_features %}
            <label style="display: flex; align-items: start; gap: 12px; padding: 16px; background: var(--bg-elevated); border-radius: 8px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='var(--bg-elevated)'">
                <input type="checkbox" name="features" value="{{ feature.id }}" style="margin-top: 4px; width: 20px; height: 20px; accent-color: var(--brand);">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">{{ feature.name }}</div>
                    <div class="text-muted" style="font-size: 13px; margin-bottom: 8px;">{{ feature.description }}</div>
                    <div>
                        <span class="badge badge-blue">{{ feature.category }}</span>
                        <span class="badge {% if feature.effort == 'low' %}badge-green{% elif feature.effort == 'medium' %}badge-yellow{% else %}badge-red{% endif %}">{{ feature.effort }} effort</span>
                        <span class="badge {% if feature.impact == 'high' %}badge-green{% elif feature.impact == 'medium' %}badge-yellow{% else %}badge-gray{% endif %}">{{ feature.impact }} impact</span>
                    </div>
                </div>
            </label>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-muted" style="text-align: center; padding: 40px;">
            <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success); margin-bottom: 16px;"></i>
            <p>All features built for {{ tool.name }}!</p>
            <button type="button" onclick="generateMore('{{ tool_id }}')" class="btn btn-primary btn-sm">
                <i class="fas fa-magic"></i> Generate More Ideas
            </button>
        </div>
        {% endif %}
    </div>
    {% endfor %}
    
    <!-- Sticky Action Bar -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-surface); border-top: 1px solid var(--border-subtle); padding: 20px; z-index: 100;">
        <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
            <div class="text-muted">
                <span id="selected-count">0</span> features selected
            </div>
            <div style="display: flex; gap: 12px;">
                <button type="button" onclick="selectHighImpact()" class="btn btn-secondary btn-md">
                    <i class="fas fa-star"></i> Select High Impact
                </button>
                <button type="button" onclick="selectQuickWins()" class="btn btn-secondary btn-md">
                    <i class="fas fa-bolt"></i> Select Quick Wins
                </button>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-hammer"></i> Build Selected
                </button>
            </div>
        </div>
    </div>
</form>

<!-- Spacer for fixed bottom bar -->
<div style="height: 100px;"></div>

<script>
// Update selected count
function updateCount() {
    const checked = document.querySelectorAll('input[name="features"]:checked');
    document.getElementById('selected-count').textContent = checked.length;
}

document.querySelectorAll('input[name="features"]').forEach(cb => {
    cb.addEventListener('change', updateCount);
});

// Select high impact features
function selectHighImpact() {
    document.querySelectorAll('input[name="features"]').forEach(cb => {
        const label = cb.closest('label');
        const impactBadge = label.querySelector('.badge-green');
        if (impactBadge && impactBadge.textContent.includes('high')) {
            cb.checked = true;
        }
    });
    updateCount();
}

// Select quick wins (low effort, high impact)
function selectQuickWins() {
    document.querySelectorAll('input[name="features"]').forEach(cb => {
        const label = cb.closest('label');
        const effortBadge = label.querySelector('.badge-green');
        const impactBadge = label.querySelector('.badge-green');
        if (effortBadge && effortBadge.textContent.includes('low') && 
            impactBadge && impactBadge.textContent.includes('high')) {
            cb.checked = true;
        }
    });
    updateCount();
}

// Generate more features
function generateMore(toolId) {
    fetch(`/api/product/generate/${toolId}`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            alert(`Generated ${data.count} new feature ideas! Reloading...`);
            window.location.reload();
        });
}

// Add to roadmap
function addToRoadmap(event) {
    event.preventDefault();
    const checked = document.querySelectorAll('input[name="features"]:checked');
    const featureIds = Array.from(checked).map(cb => cb.value);
    
    if (featureIds.length === 0) {
        alert('Please select at least one feature to build');
        return false;
    }
    
    fetch('/api/product/roadmap', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({features: featureIds})
    })
    .then(r => r.json())
    .then(data => {
        alert(`Added ${data.added.length} features to roadmap!`);
        window.location.reload();
    });
    
    return false;
}

// Mark as built
function markBuilt(featureId) {
    fetch(`/api/product/built/${featureId}`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            alert('Feature marked as built!');
            window.location.reload();
        });
}
</script>
{% endblock %}
